stages:
  - checkout
  - build
  - deploy

# -------------------------------------------------------------------
# Global variables (project, region, registry, cluster)
# -------------------------------------------------------------------
variables:
  PROJECT_ID: "sacred-garden-474511-b9"
  REGION: "us-central1"
  REPO: "mlops-iris-ii"
  REGISTRY: "us-central1-docker.pkg.dev"
  CLUSTER: "autopilot-cluster-1"

# -------------------------------------------------------------------
# Stage: checkout — placeholder to mirror typical pipelines
# -------------------------------------------------------------------
checkout_code:
  image: alpine:3.20
  stage: checkout
  script:
    - echo "Code checked out."

# Build & push with Docker-in-Docker: job image has docker CLI, service runs the daemon
build_docker_image:
  image: docker:24.0.9
  stage: build
  services:
    - name: docker:24.0.9-dind
      command: ["--tls=false"]
  variables:
    DOCKER_HOST: tcp://docker:2375 # Point docker CLI to the DinD daemon
    DOCKER_TLS_CERTDIR: ""         # Required to run DinD without TLS
  before_script:
    # Decode the base64 service account key to a file
    - echo "$GCP_SA_KEY" | base64 -d > key.json
    # Authenticate Docker to Artifact Registry using the JSON key (no gcloud needed here)
    - cat key.json | docker login -u _json_key --password-stdin https://$REGISTRY
    # Use a unique, immutable tag (recommended) and also tag :latest if you want
    - export IMAGE_SHA_TAG=$REGISTRY/$PROJECT_ID/$REPO/mlops-iris-ii:$CI_COMMIT_SHORT_SHA
    - export IMAGE_LATEST_TAG=$REGISTRY/$PROJECT_ID/$REPO/mlops-iris-ii:latest
  script:
    - docker build -t "$IMAGE_SHA_TAG" -t "$IMAGE_LATEST_TAG" .
    - docker push "$IMAGE_SHA_TAG"
    - docker push "$IMAGE_LATEST_TAG"
  after_script:
    - rm -f key.json

# -------------------------------------------------------------------
# Stage: deploy — Authenticate to GCP, get cluster creds, deploy to GKE
# -------------------------------------------------------------------
# Applies the Kubernetes manifest and pins the image to the commit SHA
# for deterministic rollouts. Waits for rollout to complete.
deploy_to_gke:
  image: google/cloud-sdk:485.0.0
  stage: deploy
  variables:
    NAMESPACE: "default"
  before_script:
    # Activate service account and set project/cluster context
    - echo "$GCP_SA_KEY" | base64 -d > key.json
    - gcloud auth activate-service-account --key-file=key.json
    - gcloud config set project $PROJECT_ID
    - gcloud container clusters get-credentials $CLUSTER --region $REGION --project $PROJECT_ID
    - export IMAGE_SHA_TAG="$REGISTRY/$PROJECT_ID/$REPO/mlops-iris-ii:$CI_COMMIT_SHORT_SHA"
  script:
    # Create/refresh Deployment and Service from your manifest
    - kubectl apply -f kubernetes-deployment.yaml -n "$NAMESPACE"

    # Overwrite the image with the commit-specific tag for deterministic rollouts
    - kubectl set image -n "$NAMESPACE" deployment/mlops-iris-ii mlops-iris-ii="$IMAGE_SHA_TAG" --record=true

    # Quick visibility + rollout confirmation
    - kubectl get deploy,svc -n "$NAMESPACE"
    - kubectl rollout status deployment/mlops-iris-ii -n "$NAMESPACE" --timeout=180s
  after_script:
    - rm -f key.json

